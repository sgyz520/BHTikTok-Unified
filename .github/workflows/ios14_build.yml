name: iOS 14.4 Compatibility Build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - '**.x'
      - '**.m'
      - '**.plist'
      - 'Makefile'
      - 'control'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Theos
      uses: Randomblock1/theos-action@v1
      with:
        theos-version: latest
        sdk-version: iPhoneOS14.4.sdk
        
    - name: Cache iOS 14.4 SDK
      uses: actions/cache@v3
      id: sdk-cache
      with:
        path: theos/sdks/
        key: ios-14-4-sdk
        
    - name: Download iOS 14.4 SDK
      if: steps.sdk-cache.outputs.cache-hit != 'true'
      run: |
        # 尝试主下载链接
        curl -L -o iPhoneOS14.4.sdk.tar.xz https://github.com/theos/sdks/releases/download/14.4/iPhoneOS14.4.sdk.tar.xz || \
        # 备用链接
        curl -L -o iPhoneOS14.4.sdk.tar.xz https://github.com/chrisharper22/sdks/releases/download/iOS14.4/iPhoneOS14.4.sdk.tar.xz || \
        # 终极备用链接
        curl -L -o iPhoneOS14.4.sdk.tar.xz https://apt.alfhaily.me/files/sdks/iPhoneOS14.4.sdk.tar.xz
        
        if [ -f iPhoneOS14.4.sdk.tar.xz ]; then
          tar -xf iPhoneOS14.4.sdk.tar.xz -C theos/sdks/
          rm iPhoneOS14.4.sdk.tar.xz
        else
          echo "❌ iOS 14.4 SDK下载失败，请检查网络连接"
          exit 1
        fi
        
    - name: Build Package
      run: |
        export THEOS=theos
        make clean
        make package FINALPACKAGE=1
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: BHTikTokUnified-iOS14.4
        path: packages/*.deb
        
    - name: Release
      if: github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        files: packages/*.deb
        tag_name: ios14.4-${{ github.run_number }}
        name: iOS 14.4 Compatible Release
        body: |
          专为iOS 14.4优化的TikTok插件版本
          - 修复SDK兼容性问题
          - 优化Bundle Filter
          - 增强稳定性
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}