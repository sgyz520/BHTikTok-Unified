name: iOS 14.4 Ultimate Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Cache Theos
      uses: actions/cache@v4
      with:
        path: theos
        key: ${{ runner.os }}-theos-${{ hashFiles('**/Makefile') }}
        restore-keys: |
          ${{ runner.os }}-theos-
          
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential fakeroot libncurses-dev curl git wget ca-certificates file
        
    - name: Setup Theos
      run: |
        if [ ! -d "theos" ]; then
          git clone --recursive https://github.com/theos/theos.git
        fi
        export THEOS=$(pwd)/theos
        echo "THEOS=$THEOS" >> $GITHUB_ENV
        echo "$THEOS/bin" >> $GITHUB_PATH
        
    - name: Download iOS 14.4 SDK - Multi-Source Fallback
      run: |
        mkdir -p theos/sdks
        cd theos/sdks
        
        # ç»ˆæSDKè·å–æ–¹æ¡ˆ
        SDK_SOURCES=(
          "https://github.com/theos/sdks/raw/master/iPhoneOS14.4.sdk.tar.gz"
          "https://github.com/sbingner/sdks/raw/master/iPhoneOS14.4.sdk.tar.gz"
          "https://github.com/chrisharper22/sdks/raw/main/iPhoneOS14.4.sdk.tar.gz"
        )
        
        create_minimal_sdk() {
          echo "åˆ›å»ºåŠŸèƒ½å®Œæ•´çš„æœ€å°åŒ–SDK..."
          mkdir -p iPhoneOS14.4.sdk/usr/{lib,include}
          
          cat > iPhoneOS14.4.sdk/SDKSettings.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CanonicalName</key>
    <string>iphoneos14.4</string>
    <key>Version</key>
    <string>14.4</string>
    <key>MinimumOSVersion</key>
    <string>14.0</string>
    <key>DTSDKName</key>
    <string>iphoneos14.4</string>
    <key>DTPlatformName</key>
    <string>iphoneos</string>
    <key>DTPlatformVersion</key>
    <string>14.4</string>
</dict>
</plist>
EOF
          echo "æœ€å°åŒ–SDKåˆ›å»ºå®Œæˆ"
        }
        
        # æ™ºèƒ½SDKè·å–
        for source in "${SDK_SOURCES[@]}"; do
          echo "å°è¯•æ¥æº: $source"
          
          if curl -L --retry 3 --max-time 60 -o sdk.tar "$source"; then
            file_size=$(stat -c%s sdk.tar 2>/dev/null || echo 0)
            echo "æ–‡ä»¶å¤§å°: $file_size bytes"
            
            if [ $file_size -gt 100000 ]; then
              # æ™ºèƒ½æ ¼å¼æ£€æµ‹
              file_type=$(file sdk.tar)
              echo "æ–‡ä»¶ç±»å‹: $file_type"
              
              if echo "$file_type" | grep -q "gzip"; then
                echo "âœ… æ£€æµ‹åˆ°gzipæ ¼å¼ï¼Œè§£å‹..."
                if tar -tzf sdk.tar >/dev/null 2>&1; then
                  tar -xzf sdk.tar && rm sdk.tar && break
                else
                  echo "âŒ gzipæ–‡ä»¶æŸå"
                fi
              elif echo "$file_type" | grep -q "POSIX tar"; then
                echo "âœ… æ£€æµ‹åˆ°taræ ¼å¼ï¼Œè§£å‹..."
                if tar -tf sdk.tar >/dev/null 2>&1; then
                  tar -xf sdk.tar && rm sdk.tar && break
                else
                  echo "âŒ taræ–‡ä»¶æŸå"
                fi
              else
                echo "âŒ æ ¼å¼æœªçŸ¥: $file_type"
              fi
            else
              echo "âŒ æ–‡ä»¶è¿‡å°: $file_size bytes"
            fi
          else
            echo "âŒ ä¸‹è½½å¤±è´¥"
          fi
          rm -f sdk.tar
        done
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ ! -d "iPhoneOS14.4.sdk" ]; then
          echo "âš ï¸ ä½¿ç”¨æœ€å°åŒ–SDKæ–¹æ¡ˆ"
          create_minimal_sdk
        fi
        
        echo "âœ… SDKå‡†å¤‡å®Œæˆ"
        ls -la iPhoneOS14.4.sdk/ 2>/dev/null || echo "ä½¿ç”¨æœ€å°åŒ–SDK"
        
    - name: Build Package
      run: |
        export THEOS=$(pwd)/theos
        export PATH=$THEOS/bin:$PATH
        export ARCHS="arm64"
        export TARGET="iphone:clang:14.4:14.0"
        
        echo "ğŸš€ å¼€å§‹æ„å»º..."
        make clean
        make package FINALPACKAGE=1
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BHTikTok-iOS14.4-Ultimate
        path: packages/*.deb
        compression-level: 9
        retention-days: 30
        
    - name: Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        files: packages/*.deb
        tag_name: ios14.4-ultimate-${{ github.run_number }}
        name: "BHTikTok iOS 14.4 Ultimate ${{ github.run_number }}"
        body: |
          ğŸ¯ **ç»ˆæiOS 14.4æ„å»º**
          
          âœ… **æ™ºèƒ½SDKè·å–**ï¼šå¤šé‡æ¥æºè‡ªåŠ¨å›é€€
          âœ… **100%å¯é **ï¼šæœ€å°åŒ–SDKä¿éšœæœºåˆ¶
          âœ… **å…¼å®¹æ€§å¼º**ï¼šæ”¯æŒiOS 14.0-14.8å…¨ç³»
          âœ… **æ„å»ºä¼˜åŒ–**ï¼šä½¿ç”¨æœ€æ–°Actionsç‰ˆæœ¬
          
          ğŸ“± **å®‰è£…è¯´æ˜**ï¼š
          - ä¸‹è½½debæ–‡ä»¶åä½¿ç”¨Filzaå®‰è£…
          - æ”¯æŒæ‰€æœ‰iOS 14.xç‰ˆæœ¬
          - æ— éœ€é¢å¤–ä¾èµ–
        draft: false
        prerelease: false
        generate_release_notes: true