name: Build and Release BHTikTok Unified

on:
  workflow_dispatch:
    inputs:
      bhtiktok_version:
        description: "The version of BHTikTok Unified"
        default: "25.9.10"
        required: true
        type: string
      decrypted_tiktok_url:
        description: "The direct URL to the decrypted TikTok ipa"
        default: ""
        required: true
        type: string
      tiktok_version:
        description: "The version of TikTok"
        default: ""
        required: true
        type: string
      bundle_id:
        description: "Modify the bundle ID. Not recommended"
        default: "com.zhiliaoapp.musically"
        required: true
        type: string
      app_name:
        description: "Modify the name of the app on the Home Screen. Not recommended"
        default: "TikTok"
        required: true
        type: string
      create_release:
        description: "Create a draft release"
        default: true
        required: false
        type: boolean
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  build:
    name: Build BHTikTok Unified
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          path: main
          submodules: recursive

      - name: Install Dependencies
        run: |
          brew install ldid dpkg make
          echo "$(brew --prefix make)/libexec/gnubin" >> $GITHUB_PATH

      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          ref: master
          path: theos
          submodules: recursive

      - name: Cache iOS SDK
        id: SDK
        uses: actions/cache@v3
        env:
          cache-name: iOS-16.5-SDK
        with:
          path: theos/sdks/
          key: ${{ env.cache-name }}

      - name: Download iOS 16.5 SDK
        if: steps.SDK.outputs.cache-hit != 'true'
        run: |
          svn checkout -q https://github.com/chrisharper22/sdks/trunk/iPhoneOS16.5.sdk
          mv *.sdk $THEOS/sdks
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Setup Theos Jailed
        uses: actions/checkout@v4
        with:
          repository: qnblackcat/theos-jailed
          ref: master
          path: theos-jailed
          submodules: recursive

      - name: Install Theos Jailed
        run: |
          ./theos-jailed/install
        env:
          THEOS: ${{ github.workspace }}/theos

      - name: Download TikTok iPA (if URL provided)
        if: ${{ inputs.decrypted_tiktok_url != '' }}
        run: |
          wget "$TIKTOK_URL" --no-verbose -O main/TikTok.ipa && echo -e "==> \033[1mTikTok v${{ inputs.tiktok_version }} downloaded! \033[0m"
        env:
          THEOS: ${{ github.workspace }}/theos
          TIKTOK_VERSION: ${{ inputs.tiktok_version }}
          TIKTOK_URL: ${{ inputs.decrypted_tiktok_url }}

      - name: Build Tweak Package
        id: build_package
        run: |
          cd ${{ github.workspace }}/main
          
          # 更新版本信息
          sed -i '' "s/Version: .*/Version: ${{ env.BHTIKTOK_VERSION }}/g" control
          
          # 构建包
          make package FINALPACKAGE=1
          
          # 重命名包文件
          PACKAGE_NAME="BHTikTokUnified_${{ env.BHTIKTOK_VERSION }}.deb"
          mv "packages/$(ls -t packages | head -n1)" "packages/$PACKAGE_NAME"
          
          echo "package=$PACKAGE_NAME" >>$GITHUB_OUTPUT
          echo -e "==> \033[1mSHASUM256: $(shasum -a 256 packages/*.deb | cut -f1 -d' ')\033[0m"
          echo -e "==> \033[1mPackage: $PACKAGE_NAME\033[0m"
        env:
          THEOS: ${{ github.workspace }}/theos
          BHTIKTOK_VERSION: ${{ inputs.bhtiktok_version || '25.9.10' }}

      - name: Build IPA (if TikTok IPA provided)
        id: build_ipa
        if: ${{ inputs.decrypted_tiktok_url != '' }}
        run: |
          cd ${{ github.workspace }}/main
          
          # 配置IPA构建
          sed -i '' "s/BUNDLE_ID = .*/BUNDLE_ID = ${{ env.BUNDLE_ID }}/g" Makefile
          sed -i '' "s/DISPLAY_NAME = .*/DISPLAY_NAME = ${{ env.APP_NAME }}/g" Makefile
          
          # 构建IPA
          make package IPA=TikTok.ipa FINALPACKAGE=1
          
          # 重命名IPA文件
          IPA_NAME="BHTikTokUnified_${{ env.TIKTOK_VERSION }}_${{ env.BHTIKTOK_VERSION }}.ipa"
          mv "packages/$(ls -t packages/*.ipa | head -n1)" "packages/$IPA_NAME"
          
          echo "ipa=$IPA_NAME" >>$GITHUB_OUTPUT
          echo -e "==> \033[1mIPA: $IPA_NAME\033[0m"
        env:
          THEOS: ${{ github.workspace }}/theos
          BHTIKTOK_VERSION: ${{ inputs.bhtiktok_version || '25.9.10' }}
          TIKTOK_VERSION: ${{ inputs.tiktok_version }}
          BUNDLE_ID: ${{ inputs.bundle_id }}
          APP_NAME: ${{ inputs.app_name }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: BHTikTokUnified_${{ inputs.bhtiktok_version || '25.9.10' }}
          path: |
            ${{ github.workspace }}/main/packages/*.deb
            ${{ github.workspace }}/main/packages/*.ipa
          if-no-files-found: error

      - name: Create Release
        id: create_release
        if: ${{ inputs.create_release == true || startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.tiktok_version && format('v{0}-{1}-({2})', inputs.tiktok_version, inputs.bhtiktok_version, github.run_number) || format('v{0}-({1})', inputs.bhtiktok_version || '25.9.10', github.run_number) }}
          name: ${{ inputs.tiktok_version && format('BHTikTok Unified v{0} for TikTok v{1}', inputs.bhtiktok_version, inputs.tiktok_version) || format('BHTikTok Unified v{0}', inputs.bhtiktok_version || '25.9.10') }}
          body: |
            ## 🎉 BHTikTok Unified Release
            
            ### 📱 版本信息 | Version Info
            - **BHTikTok Unified**: v${{ inputs.bhtiktok_version || '25.9.10' }}
            ${{ inputs.tiktok_version && format('- **TikTok**: v{0}', inputs.tiktok_version) || '' }}
            - **构建号 | Build**: #${{ github.run_number }}
            - **提交 | Commit**: ${{ github.sha }}
            
            ### 🚀 新功能 | New Features
            - 完整的功能实现与多语言支持
            - 支持12种语言的本地化
            - 现代化的设置界面
            - 增强的下载功能
            - 改进的安全性和隐私保护
            
            ### 📦 下载 | Downloads
            - **DEB包**: 适用于越狱设备
            ${{ inputs.decrypted_tiktok_url && '- **IPA文件**: 适用于侧载安装' || '' }}
            
            ### ⚠️ 注意事项 | Notes
            - 需要iOS 14.0或更高版本
            - DEB包需要越狱环境
            - IPA文件需要开发者证书或侧载工具
            
            ### 🔗 相关链接 | Links
            - [使用说明](https://github.com/${{ github.repository }}/blob/main/README.md)
            - [问题反馈](https://github.com/${{ github.repository }}/issues)
            - [Telegram频道](https://t.me/BHTikTokUnified)
          files: |
            main/packages/*.deb
            main/packages/*.ipa
          draft: ${{ inputs.create_release == true }}
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}

  test:
    name: Test Build
    runs-on: macos-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install Dependencies
        run: brew install ldid
        
      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          ref: master
          path: theos
          
      - name: Test Compilation
        run: |
          export THEOS=${{ github.workspace }}/theos
          make clean
          make
        env:
          THEOS: ${{ github.workspace }}/theos
